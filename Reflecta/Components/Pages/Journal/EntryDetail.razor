@page "/entry/{EntryId:guid}"

@inject IJournalService JournalService
@inject IAuthService AuthService
@inject IExportService ExportService
@inject ILockService LockService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>@(_entry?.Title ?? "Entry") - Reflecta</PageTitle>

@if (_isLoading)
{
    <div class="flex items-center justify-center h-64">
        <span class="material-symbols-rounded text-4xl text-accent-primary animate-spin">progress_activity</span>
    </div>
}
else if (_entry == null)
{
    <EmptyState
        Icon="article"
        Title="Entry not found"
        Description="The journal entry you're looking for doesn't exist or has been deleted."
        ActionText="Back to Entries"
        ActionUrl="/entries" />
}
else
{
    <article class="max-w-5xl mx-auto space-y-6">
        @* Header *@
        <header class="flex items-start justify-between gap-4">
            <div class="flex items-start gap-4">
                <a href="/entries" class="btn-pill-ghost p-2 mt-1">
                    <span class="material-symbols-rounded">arrow_back</span>
                </a>
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        @if (_entry.PrimaryMood != null)
                        {
                            <span class="text-3xl" title="@_entry.PrimaryMood.Name">@_entry.PrimaryMood.Emoji</span>
                        }
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-text-primary">@_entry.Title</h1>
                            <p class="text-sm text-text-muted">
                                @_entry.CreatedAt.ToString("dddd, MMMM d, yyyy") at @_entry.CreatedAt.ToString("h:mm tt")
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            @* Actions *@
            <div class="flex items-center gap-2">
                <button class="btn-pill-ghost p-2" title="@(_entry.IsFavorite ? "Remove from favorites" : "Add to favorites")"
                        @onclick="ToggleFavorite">
                    <span class="material-symbols-rounded text-xl @(_entry.IsFavorite ? "text-mood-neutral" : "")">
                        @(_entry.IsFavorite ? "star" : "star_outline")
                    </span>
                </button>
                
                <div class="relative">
                    <button class="btn-pill-ghost p-2" @onclick="ToggleMenu">
                        <span class="material-symbols-rounded text-xl">more_vert</span>
                    </button>
                    
                    @if (_showMenu)
                    {
                        <div class="absolute right-0 top-full mt-2 w-48 bg-surface-elevated rounded-2xl shadow-elevated-lg py-2 z-10 animate-scale-in">
                            <a href="/entry/@EntryId/edit" class="flex items-center gap-3 px-4 py-2 hover:bg-surface-elevated-hover transition-colors">
                                <span class="material-symbols-rounded text-lg">edit</span>
                                Edit Entry
                            </a>
                            <button class="w-full flex items-center gap-3 px-4 py-2 hover:bg-surface-elevated-hover transition-colors"
                                    @onclick="ShareEntry">
                                <span class="material-symbols-rounded text-lg">share</span>
                                Share
                            </button>
                            <button class="w-full flex items-center gap-3 px-4 py-2 hover:bg-surface-elevated-hover transition-colors"
                                    @onclick="ExportEntry">
                                <span class="material-symbols-rounded text-lg">download</span>
                                Export as PDF
                            </button>
                            <div class="h-px bg-border-subtle my-2"></div>
                            <button class="w-full flex items-center gap-3 px-4 py-2 hover:bg-mood-negative/20 text-mood-negative transition-colors"
                                    @onclick="ConfirmDelete">
                                <span class="material-symbols-rounded text-lg">delete</span>
                                Delete
                            </button>
                        </div>
                    }
                </div>
            </div>
        </header>
        
        @* Metadata Bar *@
        <div class="flex flex-wrap items-center gap-4 text-sm text-text-secondary">
            <div class="flex items-center gap-2">
                <span class="material-symbols-rounded text-lg">text_fields</span>
                @_entry.WordCount words
            </div>
            
            @if (_entry.SecondaryMoods.Any())
            {
                <div class="flex items-center gap-2">
                    <span class="material-symbols-rounded text-lg">mood</span>
                    Also feeling: 
                    @foreach (var secondary in _entry.SecondaryMoods)
                    {
                        <span title="@secondary.Mood.Name">@secondary.Mood.Emoji</span>
                    }
                </div>
            }
        </div>
        
        @* Tags *@
        @if (_entry.EntryTags.Any())
        {
            <div class="flex flex-wrap gap-2">
                @foreach (var entryTag in _entry.EntryTags)
                {
                    <span class="tag-pill">
                        <span class="material-symbols-rounded text-xs">tag</span>
                        @entryTag.Tag.Name
                    </span>
                }
            </div>
        }
        
        @* Content with Markdown Rendering *@
        <div class="card-elevated">
            <MarkdownRenderer Content="@_entry.Content" />
        </div>
        
        @* Entry Navigation *@
        <nav class="flex items-center justify-between pt-6 border-t border-border-subtle">
            @if (_previousEntryId != null)
            {
                <a href="/entry/@_previousEntryId" class="flex items-center gap-2 text-text-secondary hover:text-text-primary transition-colors">
                    <span class="material-symbols-rounded">chevron_left</span>
                    Previous entry
                </a>
            }
            else
            {
                <div></div>
            }
            
            @if (_nextEntryId != null)
            {
                <a href="/entry/@_nextEntryId" class="flex items-center gap-2 text-text-secondary hover:text-text-primary transition-colors">
                    Next entry
                    <span class="material-symbols-rounded">chevron_right</span>
                </a>
            }
        </nav>
    </article>
    
    @* Delete Confirmation Modal *@
    <Modal @bind-IsOpen="_showDeleteModal" Title="Delete Entry?">
        <ChildContent>
            <p class="text-text-secondary">
                Are you sure you want to delete this entry? This action cannot be undone.
            </p>
        </ChildContent>
        
        <FooterContent>
            <PillButton Text="Cancel" Variant="PillButton.ButtonVariant.Secondary" OnClick="() => _showDeleteModal = false" />
            <PillButton Text="Delete" Variant="PillButton.ButtonVariant.Danger" Icon="delete" OnClick="DeleteEntry" />
        </FooterContent>
    </Modal>
}

@code {
    [Parameter] public Guid EntryId { get; set; }
    
    private bool _isLoading = true;
    private JournalEntry? _entry;
    private Guid? _previousEntryId;
    private Guid? _nextEntryId;
    
    private bool _showMenu = false;
    private bool _showDeleteModal = false;
    
    protected override async Task OnInitializedAsync()
    {
        if (LockService.IsLocked)
        {
            NavigationManager.NavigateTo("/pin-lock", replace: true);
            return;
        }

        if (!AuthService.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }
        
        await LoadEntryAsync();
        _isLoading = false;
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (!_isLoading)
        {
            _isLoading = true;
            StateHasChanged();
            await LoadEntryAsync();
            _isLoading = false;
        }
    }
    
    private async Task LoadEntryAsync()
    {
        var userId = AuthService.CurrentUserId!.Value;
        
        _entry = await JournalService.GetEntryByIdAsync(EntryId, userId);
        
        if (_entry == null)
        {
            return;
        }
        
        // Load adjacent entries for navigation
        var allEntries = await JournalService.GetEntriesAsync(userId, new EntryFilterDto { PageSize = 1000 });
        var sortedEntries = allEntries.Items.OrderByDescending(e => e.CreatedAt).ToList();
        var currentIndex = sortedEntries.FindIndex(e => e.Id == EntryId);
        
        if (currentIndex > 0)
        {
            _nextEntryId = sortedEntries[currentIndex - 1].Id;
        }
        
        if (currentIndex < sortedEntries.Count - 1)
        {
            _previousEntryId = sortedEntries[currentIndex + 1].Id;
        }
    }
    
    private async Task ToggleFavorite()
    {
        if (_entry == null) return;
        
        var userId = AuthService.CurrentUserId!.Value;
        var result = await JournalService.ToggleFavoriteAsync(EntryId, userId);
        
        if (result.Success)
        {
            _entry.IsFavorite = result.IsFavorite;
        }
    }
    
    private void ToggleMenu()
    {
        _showMenu = !_showMenu;
    }
    
    private async Task ShareEntry()
    {
        _showMenu = false;
        
        if (_entry == null) return;
        
        // Build share text
        var shareText = $"{_entry.Title}\n\n{_entry.Content}";
        if (_entry.PrimaryMood != null)
        {
            shareText = $"{_entry.PrimaryMood.Emoji} {shareText}";
        }
        
        // Use Web Share API if available, otherwise copy to clipboard
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", $@"
                if (navigator.share) {{
                    navigator.share({{
                        title: '{EscapeJsString(_entry.Title ?? "Journal Entry")}',
                        text: '{EscapeJsString(shareText)}'
                    }});
                }} else {{
                    navigator.clipboard.writeText('{EscapeJsString(shareText)}');
                    alert('Entry copied to clipboard!');
                }}
            ");
        }
        catch
        {
            // Fallback: copy to clipboard
            await JSRuntime.InvokeVoidAsync("eval", $@"
                navigator.clipboard.writeText('{EscapeJsString(shareText)}');
                alert('Entry copied to clipboard!');
            ");
        }
    }
    
    private string EscapeJsString(string input)
    {
        return input
            .Replace("\\", "\\\\")
            .Replace("'", "\\'")
            .Replace("\n", "\\n")
            .Replace("\r", "\\r");
    }
    
    private async Task ExportEntry()
    {
        _showMenu = false;
        
        if (_entry == null) return;
        
        var userId = AuthService.CurrentUserId!.Value;
        
        var options = new ExportOptions
        {
            StartDate = _entry.EntryDate,
            EndDate = _entry.EntryDate,
            Format = ExportFormat.PDF,
            IncludeMoods = true,
            IncludeTags = true,
            IncludeWordCount = true
        };
        
        var result = await ExportService.ExportEntriesAsync(userId, options);
        
        if (result.Success && result.FileData != null)
        {
            // Trigger file download
            var base64 = Convert.ToBase64String(result.FileData);
            var dataUrl = $"data:{result.ContentType};base64,{base64}";
            
            await JSRuntime.InvokeVoidAsync("eval", $@"
                var a = document.createElement('a');
                a.href = '{dataUrl}';
                a.download = '{result.FileName}';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            ");
        }
    }
    
    private void ConfirmDelete()
    {
        _showMenu = false;
        _showDeleteModal = true;
    }
    
    private async Task DeleteEntry()
    {
        var userId = AuthService.CurrentUserId!.Value;
        var result = await JournalService.DeleteEntryAsync(EntryId, userId);
        _showDeleteModal = false;
        
        if (result.Success)
        {
            NavigationManager.NavigateTo("/entries");
        }
    }
}
